var whatsappscraper=(()=>{var y=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var O=(r,e)=>{for(var t in e)y(r,t,{get:e[t],enumerable:!0})},B=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of M(e))!E.call(r,a)&&a!==t&&y(r,a,{get:()=>e[a],enumerable:!(i=C(e,a))||i.enumerable});return r};var D=r=>B(y({},"__esModule",{value:!0}),r);var N={};O(N,{createScraperState:()=>v,mergeMessages:()=>j,scrape:()=>k,whatsappMessages:()=>$});var I=v();function A(r){if(!r)return;let e=r.cloneNode(!0);for(let t of e.querySelectorAll("[data-plain-text]"))t.replaceWith(t.dataset.plainText);for(let t of e.querySelectorAll("img.emoji[alt]"))t.replaceWith(t.alt);return e.textContent}function v(r){let e=Object.create(null);if(r)for(let[t,i]of Object.entries(r))e[t]=i;return{messagesById:e,captureTimer:null}}function $(r=document){let e=[],t,i;for(let a of r.querySelectorAll('#main [role="row"]')){let s,o=!1,l=!1,[c,d,p,x,W,_]=a.querySelector("[data-id]").dataset.id.split(/[_@]/);c=c==="true";let m=!!a.querySelector('[data-icon="recalled"]'),n={messageId:x,isSystemMessage:c,isRecalled:m,userId:d};if(c&&!m&&(n.text=a.outerText),!c&&!m){let f=a.querySelector(".selectable-text");s=A(f),l=!!a.querySelector('[aria-label="Play GIF" i]');let g=a.querySelector('[role=""]');n.author=g?.querySelector("[dir]")?.textContent,s||(l?s="(media-gif)":(s=a.textContent,o=!0)),!g&&!n.author&&s&&(n.author=t);let u=a.querySelector("[data-pre-plain-text]")?.dataset.prePlainText,{date:b,phone:T}=P(u);if(n.time=b,T&&(n.authorPhone=T),!n.time){let w=[...a.querySelectorAll('[dir="auto"]')].at(-1);w&&(n.time=R(i,w.textContent))}}i=n.time,t=n.author;let h=a.querySelector('[aria-label="Quoted message" i]');if(h){let f=h.querySelector('[role=""] :not([aria-label])')?.textContent,g=h.querySelector('[role=""] [aria-label]')?.textContent;if(g?(n.quoteAuthorPhone=f.replace(/[^0-9]+/g,""),n.quoteAuthor=g):n.quoteAuthor=f,n.quoteText=A(h.querySelector(".quoted-mention")),n.quoteText)for(let u=e.length-1;u>=0;u--){let b=n.quoteText.replace(/\s+/gs," ").trim();if(n.quoteAuthor==e[u].author&&e[u].text&&e[u].text.replace(/\s+/gs," ").trim().startsWith(b)){n.quoteMessageId=e[u].messageId;break}}}let S=a.querySelector('[aria-label^="Reactions "],[aria-label^="reaction "]');if(S&&(n.reactions=S.getAttribute("aria-label").replace(/view reactions/i,"").replace(/^reactions? */i,"").replace(/ *in total/i,"").replace(/[, .]+$/,"")),!c&&!m){let f=L(s,{author:n.author,quoteAuthor:n.quoteAuthor,quoteText:n.quoteText,usedFallback:o,hasGif:l});f?n.text=f:delete n.text}e.push(n)}return e}function P(r){let e={date:null,phone:null};if(!r)return e;let t=r.match(/\[(\d{1,2}:\d{2}\s?[ap]m),\s?(\d{1,2})\/(\d{1,2})\/(\d{4})\]\s*(.+?):\s*$/);return t&&(e.date=new Date(`${t[4]}-${t[3]}-${t[2]} ${t[1]}`),e.phone=t[5].trim()),e}function R(r,e){let t=e.match(/(\d+):(\d+)\s+(am|pm)/i);if(!t)return null;let[i,a]=t.slice(1,3).map(Number),s=/pm/i.test(e),o=r?new Date(r):new Date;return o.setHours(i%12+(s?12:0),a,0,0),o.toISOString()}function j(r,e=I){for(let t of r){let i=e.messagesById[t.messageId]||{};for(let[a,s]of Object.entries(t)){let o=i[a];typeof s=="string"?(s?.length||0)>(o?.length||0)&&(i[a]=s):o||(i[a]=s)}e.messagesById[t.messageId]=i}}function k({document:r=document,navigator:e=typeof navigator>"u"?void 0:navigator,state:t=I,setIntervalFn:i=setInterval,clearIntervalFn:a=clearInterval}={}){r.body.insertAdjacentHTML("beforeend",'<button id="copy-btn" style="position:fixed;top:10px;right:10px;padding:10px;z-index:999;background-color:#fff;color:#000;">Copy 0 messages</button>');let s=r.getElementById("copy-btn"),o=()=>{j($(r),t),s.textContent=`Copy ${Object.values(t.messagesById).filter(l=>l.text).length} messages`};o(),t.captureTimer=i(o,500),s.addEventListener("click",async()=>{a(t.captureTimer),t.captureTimer=null,s.remove();let l=Object.values(t.messagesById).sort((c,d)=>{let p=c.time?new Date(c.time).getTime():0,x=d.time?new Date(d.time).getTime():0;return p-x});await e?.clipboard?.writeText?.(JSON.stringify(l,null,2))})}function L(r,{author:e,quoteAuthor:t,quoteText:i,usedFallback:a,hasGif:s}={}){if(typeof r!="string")return r;let o=r;if(i){let l=i.replace(/\s+/g," ").trim(),c=[i,l,l.replace(/^"|"$/g,"")];for(let d of c){if(!d)continue;let p=q(d);p&&(o=o.replace(new RegExp(p,"gi"),""))}}if(a&&e){let l=q(e);o=o.replace(new RegExp(`^${l}\\s*`,"i"),"")}if(a&&t){let l=q(t);o=o.replace(new RegExp(l,"gi"),"")}return a&&(o=o.replace(/\bMaybe\b/gi,""),o=o.replace(/\+?\d[\d\s-]{5,}/g,"")),o=o.replace(/Your browser doesn't support video playback\.?/gi,"").replace(/\btenor\b/gi,"").replace(/\bforward-[\w-]+\b/gi,"").replace(/\b\d{1,2}:\d{2}\s*(?:am|pm)\b/gi,""),(s||/media-gif/i.test(o))&&(o="(media-gif)"),o=o.replace(/[“”]/g,'"'),o=o.replace(/\s+/g," ").trim(),o=o.replace(/^["']+|["']+$/g,"").trim(),o||(s?"(media-gif)":null)}function q(r){return r?r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):""}return D(N);})();
