var whatsappscraper=(()=>{var y=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var O=(o,e)=>{for(var r in e)y(o,r,{get:e[r],enumerable:!0})},B=(o,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of M(e))!j.call(o,a)&&a!==r&&y(o,a,{get:()=>e[a],enumerable:!(i=C(e,a))||i.enumerable});return o};var D=o=>B(y({},"__esModule",{value:!0}),o);var L={};O(L,{createScraperState:()=>v,mergeMessages:()=>$,scrape:()=>R,whatsappMessages:()=>A});var I=v();function v(o){let e=Object.create(null);if(o)for(let[r,i]of Object.entries(o))e[r]=i;return{messagesById:e,captureTimer:null}}function A(o=document){let e=[],r,i;for(let a of o.querySelectorAll('#main [role="row"]')){let s,t=!1,l=!1,[c,d,f,h,_,N]=a.querySelector("[data-id]").dataset.id.split(/[_@]/);c=c==="true";let m=!!a.querySelector('[data-icon="recalled"]'),n={messageId:h,isSystemMessage:c,isRecalled:m,userId:d};if(c&&!m&&(n.text=a.outerText),!c&&!m){s=a.querySelector(".selectable-text")?.outerText,l=!!a.querySelector('[aria-label="Play GIF" i]');let g=a.querySelector('[role=""]');n.author=g?.querySelector("[dir]")?.textContent,s||(l?s="(media-gif)":(s=a.textContent,t=!0)),!g&&!n.author&&s&&(n.author=r);let u=a.querySelector("[data-pre-plain-text]")?.dataset.prePlainText,{date:x,phone:T}=E(u);if(n.time=x,T&&(n.authorPhone=T),!n.time){let w=[...a.querySelectorAll('[dir="auto"]')].at(-1);w&&(n.time=P(i,w.textContent))}}i=n.time,r=n.author;let b=a.querySelector('[aria-label="Quoted message" i]');if(b){let p=b.querySelector('[role=""] :not([aria-label])')?.textContent,g=b.querySelector('[role=""] [aria-label]')?.textContent;if(g?(n.quoteAuthorPhone=p.replace(/[^0-9]+/g,""),n.quoteAuthor=g):n.quoteAuthor=p,n.quoteText=b.querySelector(".quoted-mention")?.outerText,n.quoteText)for(let u=e.length-1;u>=0;u--){let x=n.quoteText.replace(/\s+/gs," ").trim();if(n.quoteAuthor==e[u].author&&e[u].text&&e[u].text.replace(/\s+/gs," ").trim().startsWith(x)){n.quoteMessageId=e[u].messageId;break}}}let S=a.querySelector('[aria-label^="Reactions "],[aria-label^="reaction "]');if(S&&(n.reactions=S.getAttribute("aria-label").replace(/view reactions/i,"").replace(/^reactions? */i,"").replace(/ *in total/i,"").replace(/[, .]+$/,"")),!c&&!m){let p=k(s,{author:n.author,quoteAuthor:n.quoteAuthor,quoteText:n.quoteText,usedFallback:t,hasGif:l});p?n.text=p:delete n.text}e.push(n)}return e}function E(o){let e={date:null,phone:null};if(!o)return e;let r=o.match(/\[(\d{1,2}:\d{2}\s?[ap]m),\s?(\d{1,2})\/(\d{1,2})\/(\d{4})\]\s*(.+?):\s*$/);return r&&(e.date=new Date(`${r[4]}-${r[3]}-${r[2]} ${r[1]}`),e.phone=r[5].trim()),e}function P(o,e){let r=e.match(/(\d+):(\d+)\s+(am|pm)/i);if(!r)return null;let[i,a]=r.slice(1,3).map(Number),s=/pm/i.test(e),t=o?new Date(o):new Date;return t.setHours(i%12+(s?12:0),a,0,0),t.toISOString()}function $(o,e=I){for(let r of o){let i=e.messagesById[r.messageId]||{};for(let[a,s]of Object.entries(r)){let t=i[a];typeof s=="string"?(s?.length||0)>(t?.length||0)&&(i[a]=s):t||(i[a]=s)}e.messagesById[r.messageId]=i}}function R({document:o=document,navigator:e=typeof navigator>"u"?void 0:navigator,state:r=I,setIntervalFn:i=setInterval,clearIntervalFn:a=clearInterval}={}){o.body.insertAdjacentHTML("beforeend",'<button id="copy-btn" style="position:fixed;top:10px;right:10px;padding:10px;z-index:999;background-color:#fff;color:#000;">Copy 0 messages</button>');let s=o.getElementById("copy-btn"),t=()=>{$(A(o),r),s.textContent=`Copy ${Object.values(r.messagesById).filter(l=>l.text).length} messages`};t(),r.captureTimer=i(t,500),s.addEventListener("click",async()=>{a(r.captureTimer),r.captureTimer=null,s.remove();let l=Object.values(r.messagesById).sort((c,d)=>{let f=c.time?new Date(c.time).getTime():0,h=d.time?new Date(d.time).getTime():0;return f-h});await e?.clipboard?.writeText?.(JSON.stringify(l,null,2))})}function k(o,{author:e,quoteAuthor:r,quoteText:i,usedFallback:a,hasGif:s}={}){if(typeof o!="string")return o;let t=o;if(i){let l=i.replace(/\s+/g," ").trim(),c=[i,l,l.replace(/^"|"$/g,"")];for(let d of c){if(!d)continue;let f=q(d);f&&(t=t.replace(new RegExp(f,"gi"),""))}}if(a&&e){let l=q(e);t=t.replace(new RegExp(`^${l}\\s*`,"i"),"")}if(a&&r){let l=q(r);t=t.replace(new RegExp(l,"gi"),"")}return a&&(t=t.replace(/\bMaybe\b/gi,""),t=t.replace(/\+?\d[\d\s-]{5,}/g,"")),t=t.replace(/Your browser doesn't support video playback\.?/gi,"").replace(/\btenor\b/gi,"").replace(/\bforward-[\w-]+\b/gi,"").replace(/\b\d{1,2}:\d{2}\s*(?:am|pm)\b/gi,""),(s||/media-gif/i.test(t))&&(t="(media-gif)"),t=t.replace(/[“”]/g,'"'),t=t.replace(/\s+/g," ").trim(),t=t.replace(/^["']+|["']+$/g,"").trim(),t||(s?"(media-gif)":null)}function q(o){return o?o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):""}return D(L);})();
