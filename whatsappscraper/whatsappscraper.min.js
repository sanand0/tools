var whatsappscraper=(()=>{var T=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var E=(e,t)=>{for(var r in t)T(e,r,{get:t[r],enumerable:!0})},O=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of P(t))!z.call(e,n)&&n!==r&&T(e,n,{get:()=>t[n],enumerable:!(s=M(t,n))||s.enumerable});return e};var N=e=>O(T({},"__esModule",{value:!0}),e);var F={};E(F,{createScraperState:()=>C,mergeMessages:()=>B,scrape:()=>J,whatsappMessages:()=>D});var j=C();function A(e){if(!e)return;let t=e.cloneNode(!0);for(let r of t.querySelectorAll("[data-plain-text]"))r.replaceWith(r.dataset.plainText);for(let r of t.querySelectorAll("img.emoji[alt]"))r.replaceWith(r.alt);return t.textContent}function C(e){let t=Object.create(null);if(e)for(let[r,s]of Object.entries(e))t[r]=s;return{messagesById:t,captureTimer:null}}function D(e=document){let t=[],r,s;for(let n of e.querySelectorAll('#main [role="row"]')){let a,i=!1,l=!1,[f,d,g,h,b,q]=n.querySelector("[data-id]").dataset.id.split(/[_@]/);f=f==="true";let x=!!n.querySelector('[data-icon="recalled"]'),o={messageId:h,isSystemMessage:f,isRecalled:x,userId:d};if(f&&!x&&(o.text=n.outerText),!f&&!x){let c=n.querySelector(".selectable-text");a=A(c),l=!!n.querySelector('[aria-label="Play GIF" i]');let m=n.querySelector('[role=""]');o.author=m?.querySelector("[dir]")?.textContent,a||(l?a="(media-gif)":(a=n.textContent,i=!0)),!m&&!o.author&&a&&(o.author=r);let p=n.querySelector("[data-pre-plain-text]")?.dataset.prePlainText,{date:S,phone:k}=H(p);if(o.time=S,k&&(o.authorPhone=k),!o.time){let v=[...n.querySelectorAll('[dir="auto"]')].at(-1);v&&(o.time=G(s,v.textContent))}}s=o.time,r=o.author;let u=n.querySelector('[aria-label="Quoted message" i]');if(u){let c=u.querySelector('[role=""] :not([aria-label])')?.textContent,m=u.querySelector('[role=""] [aria-label]')?.textContent;if(m?(o.quoteAuthorPhone=c.replace(/[^0-9]+/g,""),o.quoteAuthor=m):o.quoteAuthor=c,o.quoteText=A(u.querySelector(".quoted-mention")),o.quoteText)for(let p=t.length-1;p>=0;p--){let S=o.quoteText.replace(/\s+/gs," ").trim();if(o.quoteAuthor==t[p].author&&t[p].text&&t[p].text.replace(/\s+/gs," ").trim().startsWith(S)){o.quoteMessageId=t[p].messageId;break}}}let y=n.querySelector('[aria-label^="Reactions "],[aria-label^="reaction "]');if(y&&(o.reactions=y.getAttribute("aria-label").replace(/view reactions/i,"").replace(/^reactions? */i,"").replace(/ *in total/i,"").replace(/[, .]+$/,"")),!f&&!x){let c=_(n,{author:o.author,authorPhone:o.authorPhone,rawText:a});c&&(o.linkUrl=c.url,o.linkSite=c.site,c.title&&(o.linkTitle=c.title),c.description&&(o.linkDescription=c.description));let m=Y(a,{author:o.author,quoteAuthor:o.quoteAuthor,quoteText:o.quoteText,usedFallback:i,hasGif:l});if(m){if(o.text=m,c?.title&&L(m)===L(c.url)){let p=[c.title,c.description].filter(Boolean);p.length&&(o.text=[m,...p].join(`
`))}}else delete o.text}t.push(o)}return t}function L(e){return typeof e!="string"?"":e.trim().replace(/\/+$/,"")}function w(e){return(e||"").split(/\n+/).map(t=>t.trim()).filter(Boolean)}function $(e){return L((e||"").trim()).toLowerCase()}function Q(e){return/^\d{1,2}:\d{2}\s*(?:am|pm)\b/i.test(e||"")}function R(e){return/^\d{1,3}$/.test((e||"").trim())}function U(e){return/^[a-z0-9.-]+\.[a-z]{2,}$/i.test((e||"").trim())}function W(e){let t=(e||"").trim();return t?/^https?:\/\//i.test(t)?!0:/\s/.test(t)?!1:/[a-z0-9]/i.test(t)&&/[/.]/.test(t):!1}function _(e,{author:t,authorPhone:r,rawText:s}={}){let n=e.querySelector('.selectable-text a[href^="http"],a[href^="http"]');if(!n?.href)return null;let a;try{a=new URL(n.href).hostname.replace(/^www\./i,"")}catch{return null}let i=typeof s=="string"?s:A(e.querySelector(".selectable-text")),l=new Set(w(i)),f=new Set(w(e.querySelector('[aria-label="Quoted message" i]')?.innerText)),d=$(n.href),g=w(e.innerText),h=g.findIndex(u=>{let y=$(u);return W(u)?y===d||y.includes(d)||d.includes(y):!1});if(h<0)return{url:n.href,site:a};let b=g.slice(0,h).filter(u=>!(t&&u===t||r&&u===r||l.has(u)||f.has(u)||Q(u)||R(u)));U(b.at(-1))&&(b=b.slice(0,-1));let[q,...x]=b,o=x.join(`
`).trim()||void 0;return q?{url:n.href,site:a,title:q,description:o}:{url:n.href,site:a}}function H(e){let t={date:null,phone:null};if(!e)return t;let r=e.match(/\[(\d{1,2}:\d{2}\s?[ap]m),\s?(\d{1,2})\/(\d{1,2})\/(\d{4})\]\s*(.+?):\s*$/);return r&&(t.date=new Date(`${r[4]}-${r[3]}-${r[2]} ${r[1]}`),t.phone=r[5].trim()),t}function G(e,t){let r=t.match(/(\d+):(\d+)\s+(am|pm)/i);if(!r)return null;let[s,n]=r.slice(1,3).map(Number),a=/pm/i.test(t),i=e?new Date(e):new Date;return i.setHours(s%12+(a?12:0),n,0,0),i.toISOString()}function B(e,t=j){for(let r of e){let s=t.messagesById[r.messageId]||{};for(let[n,a]of Object.entries(r)){let i=s[n];typeof a=="string"?(a?.length||0)>(i?.length||0)&&(s[n]=a):i||(s[n]=a)}t.messagesById[r.messageId]=s}}function J({document:e=document,navigator:t=typeof navigator>"u"?void 0:navigator,state:r=j,setIntervalFn:s=setInterval,clearIntervalFn:n=clearInterval}={}){e.body.insertAdjacentHTML("beforeend",'<button id="copy-btn" style="position:fixed;top:10px;right:10px;padding:10px;z-index:999;background-color:#fff;color:#000;">Copy 0 messages</button>');let a=e.getElementById("copy-btn"),i=()=>{B(D(e),r),a.textContent=`Copy ${Object.values(r.messagesById).filter(l=>l.text).length} messages`};i(),r.captureTimer=s(i,500),a.addEventListener("click",async()=>{n(r.captureTimer),r.captureTimer=null,a.remove();let l=Object.values(r.messagesById).sort((f,d)=>{let g=f.time?new Date(f.time).getTime():0,h=d.time?new Date(d.time).getTime():0;return g-h});await t?.clipboard?.writeText?.(JSON.stringify(l,null,2))})}function Y(e,{author:t,quoteAuthor:r,quoteText:s,usedFallback:n,hasGif:a}={}){if(typeof e!="string")return e;let i=e;if(s){let l=s.replace(/\s+/g," ").trim(),f=[s,l,l.replace(/^"|"$/g,"")];for(let d of f){if(!d)continue;let g=I(d);g&&(i=i.replace(new RegExp(g,"gi"),""))}}if(n&&t){let l=I(t);i=i.replace(new RegExp(`^${l}\\s*`,"i"),"")}if(n&&r){let l=I(r);i=i.replace(new RegExp(l,"gi"),"")}return n&&(i=i.replace(/\bMaybe\b/gi,""),i=i.replace(/\+?\d[\d\s-]{5,}/g,"")),i=i.replace(/Your browser doesn't support video playback\.?/gi,"").replace(/\btenor\b/gi,"").replace(/\bforward-[\w-]+\b/gi,"").replace(/\b\d{1,2}:\d{2}\s*(?:am|pm)\b/gi,""),(a||/media-gif/i.test(i))&&(i="(media-gif)"),i=i.replace(/[“”]/g,'"'),i=i.replace(/\s+/g," ").trim(),i=i.replace(/^["']+|["']+$/g,"").trim(),i||(a?"(media-gif)":null)}function I(e){return e?e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):""}return N(F);})();
